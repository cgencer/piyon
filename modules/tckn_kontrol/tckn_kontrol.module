<?php

use Drupal\Core\Form\FormStateInterface;

/**
 * Implements hook_permissions()
 */
function tckn_kontrol_permissions() {
  return array(
    'view tckn' => array(
      'title' => t('view TCKN'),
      'description' => t('Allows users to view another user\'s TCKN'),
    ),
  );
}

/**
 * Implements hook_form_alter().
 */
function tckn_kontrol_form_alter(&$form, \Drupal\Core\Form\FormStateInterface $form_state, $form_id) {
  switch ($form_id) {
    case 'user_register_form':
        //$entered = $form_state->getObject()->getEntity()->field_tckn;
        $chopped = substr($entered, 0, 9);
        $i = 0;
        for ($x = 0; $x < strlen($chopped); $x += 2) {
          $i += $chopped[$x];
        }
        $y = 0;
        for ($x = 1; $x < strlen($chopped); $x += 2) {
          $y += $chopped[$x];
        }
        $z = 0;
        for ($x = 0; $x < strlen($chopped); $x++) {
          $z += $chopped[$x];
        }
        $tenth = (($i * 7) - $y) % 10;
        $eleventh = ($z + $tenth) % 10;
        $final = $chopped.$tenth.$eleventh;
        if (substr($entered, 0, 1) == 0) {
          $form_state->setErrorByName('field_tckn', t('You can\'t start TCKN with 0.'));
        }
        if (strlen($entered) < 11) {
          $form_state->setErrorByName('field_tckn', t('TCKN can\'t be less than 11 characters.'));
        }
        $exists = db_query('SELECT field_tckn_value FROM {user__data_field_tckn} WHERE field_tckn_no_value = :entered', array(':entered' => $entered))->fetchField();
        if ($exists) {
          $form_state->setErrorByName('field_tckn', t('Another user with the same TCKN exists'));
        }
        if ($entered != $final) {
          $form_state->setErrorByName('field_tckn', t('Your TCKN doesn\'t validate'));
      }
      break;
    case 'user_form':
    case 'user_profile_form':
      $entered = $form_state->getObject()->getEntity()->field_tckn;
      $chopped = substr($entered, 0, 9);
      $i = 0;
      for ($x = 0; $x < strlen($chopped); $x += 2) {
        $i += $chopped[$x];
      }
      $y = 0;
      for ($x = 1; $x < strlen($chopped); $x += 2) {
        $y += $chopped[$x];
      }
      $z = 0;
      for ($x = 0; $x < strlen($chopped); $x++) {
        $z += $chopped[$x];
      }
      $tenth = (($i * 7) - $y) % 10;
      $eleventh = ($z + $tenth) % 10;
      $final = $chopped.$tenth.$eleventh;
      if (substr($entered, 0, 1) == 0) {
        $form_state->setErrorByName('field_tckn', t('You can\'t start TCKN with 0.'));
      }
      if (strlen($entered) < 11) {
        $form_state->setErrorByName('field_tckn', t('TCKN can\'t be less than 11 characters.'));
      }
      $exists = db_query('SELECT field_tckn_value FROM {user__data_field_tckn} WHERE field_tckn_no_value = :entered', array(':entered' => $entered))->fetchField();
      if ($exists) {
        $form_state->setErrorByName('field_tckn', t('Another user with the same TCKN exists'));
      }
      if ($entered != $final) {
        $form_state->setErrorByName('field_tckn', t('Your TCKN doesn\'t validate'));
      }
      $form['field_tckn']['#disabled'] = (isset($form['field_tckn']['und'][0]['value'])) ? TRUE : FALSE;
      $form['field_tckn']['#access'] = FALSE;
      break;
    case 'default':
      break;
  }
}
